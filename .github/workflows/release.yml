name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build module package
        shell: pwsh
        run: |
          $buildPath = "./build/PackageFactory"
          New-Item -Path $buildPath -ItemType Directory -Force
          Copy-Item -Path ./src/* -Destination $buildPath -Recurse -Force

          # Copy additional files
          Copy-Item -Path ./README.md -Destination $buildPath -Force
          Copy-Item -Path ./LICENSE -Destination $buildPath -Force
          Copy-Item -Path ./CHANGELOG.md -Destination $buildPath -Force

          # Create zip for release
          Compress-Archive -Path $buildPath -DestinationPath "./PackageFactory-v${{ steps.get_version.outputs.version }}.zip" -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            PackageFactory-v${{ steps.get_version.outputs.version }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-psgallery:
    name: Publish to PowerShell Gallery
    runs-on: windows-latest
    needs: create-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if (-not $env:PSGALLERY_API_KEY) {
            Write-Warning "PSGALLERY_API_KEY not set. Skipping publication."
            exit 0
          }

          # Build module
          $buildPath = "./build/PackageFactory"
          New-Item -Path $buildPath -ItemType Directory -Force
          Copy-Item -Path ./src/* -Destination $buildPath -Recurse -Force

          # Publish
          Publish-Module -Path $buildPath -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose
